{% extends 'base.html' %}

{# SEO Meta Tags for Blog Post #}
{% block seo_meta %}
{% include 'includes/seo_meta.html' %}
{% endblock seo_meta %}

{% block title %}{{ post.name }} | Nestova Blog{% endblock %}

{% block extra_head %}
{# Structured Data for Blog Article #}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ post.name|escapejs }}",
  "description": "{{ post.text|striptags|truncatewords:50|escapejs }}",
  "image": "{% if post.image %}{{ request.scheme }}://{{ request.get_host }}{{ post.image.url }}{% endif %}",
  "datePublished": "{{ post.publish|date:'c' }}",
  "dateModified": "{{ post.updated|date:'c' }}",
  "author": {
    "@type": "Person",
    "name": "{{ post.author|escapejs }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Nestova",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ request.scheme }}://{{ request.get_host }}/static/assets/img/logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ request.build_absolute_uri }}"
  }
}
</script>
{% endblock extra_head %}



{% block content %}


<main class="main">

  <!-- Page Title -->
  <div class="page-title">
    <div class="heading">
      <div class="container">
        <div class="row d-flex justify-content-center text-center">
          <div class="col-lg-8">
            <h1 class="heading-title">Blog Details</h1>
            <p class="mb-0">
              Odio et unde deleniti. Deserunt numquam exercitationem. Officiis quo
              odio sint voluptas consequatur ut a odio voluptatem. Sit dolorum
              debitis veritatis natus dolores. Quasi ratione sint. Sit quaerat
              ipsum dolorem.
            </p>
          </div>
        </div>
      </div>
    </div>
    <nav class="breadcrumbs">
      <div class="container">
        <ol>
          <li><a href="index.html">Home</a></li>
          <li class="current">Blog Details</li>
        </ol>
      </div>
    </nav>
  </div><!-- End Page Title -->

  <!-- Blog Details Section -->
  <section id="blog-details" class="blog-details section">
    <div class="container" data-aos="fade-up">

      <article class="article">

        <div class="hero-img" data-aos="zoom-in">
          <img src="{{ post.image.url }}" alt="{{ post.name }}" class="img-fluid" loading="lazy">
          <div class="meta-overlay">
            <div class="meta-categories">
              <a href="#" class="category">{{ post.category.name }}</a>
              <span class="divider">•</span>
              <span class="reading-time"><i class="bi bi-clock"></i> 6 min read</span>
            </div>
          </div>
        </div>

        <div class="article-content" data-aos="fade-up" data-aos-delay="100">
          <div class="content-header">
            <h1 class="title">Modern Web Development: Best Practices and Future Trends for 2025</h1>

            <div class="author-info">
              <div class="author-details">
                <img src="{{ post.author.user.get_users_image }}" alt="Author" class="author-img">
                <div class="info">
                  <h4>{{ post.author }}</h4>
                  <span class="role">{{ post.author.role|default:"Contributor" }}</span>
                </div>
              </div>
              <div class="post-meta">
                <span class="date"><i class="bi bi-calendar3"></i>{{ post.publish }}</span>
                <span class="divider">•</span>
                <span class="comments"><i class="bi bi-chat-text"></i> 18 Comments</span>
              </div>
            </div>
          </div>

          <div class="content">
            {{ post.text|safe }}
          </div>

          <div class="meta-bottom">
            <div class="tags-section">
              <h4>Related Topics</h4>
              <div class="tags">
                <a href="#" class="tag">Web Development</a>
                <a href="#" class="tag">Performance</a>
                <a href="#" class="tag">Best Practices</a>
                <a href="#" class="tag">Trends</a>
                <a href="#" class="tag">2025</a>
              </div>
            </div>

            <div class="share-section">
              <h4>Share Article</h4>
              <div class="social-links">
                <a href="#" class="twitter"><i class="bi bi-twitter-x"></i></a>
                <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
                <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
                <a href="#" class="copy-link" title="Copy Link"><i class="bi bi-link-45deg"></i></a>
              </div>
            </div>
          </div>
        </div>

      </article>

    </div>
  </section><!-- /Blog Details Section -->

  <!-- Blog Comments Section -->
  <section id="blog-comments" class="blog-comments section">

    <div class="container" data-aos="fade-up" data-aos-delay="100">
      <div class="blog-comments-4">
        <div class="comments-header">
          <h3 class="title">Community Feedback</h3>
          <div class="comments-stats">
            <span id="comment-count" class="count">{{ comment_posts.count }}</span>
            <span class="label">Comments</span>
          </div>
        </div>

        <div class="comments-container" id="comments-container">
          <!-- Comment #1 -->
          {% for comments in comment_posts %}
          <div class="comment-thread">
            <div class="comment-box">
              <div class="comment-wrapper">
                <div class="avatar-wrapper">
                  <img src="{{ comments.user.get_users_image }}" alt="Avatar" loading="lazy">
                  <span class="status-indicator"></span>
                </div>
                <div class="comment-content">
                  <div class="comment-header">
                    <div class="user-info">
                      <h4>{{ comments.user.username|title }}</h4>
                      <span class="time-badge">
                        <i class="bi bi-clock"></i>
                        {{ comments.created|timesince }} Ago
                      </span>
                    </div>
                  </div>

                  <div class="comment-body">
                    <p>{{ comments.text }}</p>
                  </div>
                </div>
              </div>
            </div>

          </div>
          {% empty %}
          <p>No comments yet. Be the first to comment!</p>
          {% endfor %}

        </div>
      </div>

    </div>

  </section><!-- /Blog Comments Section -->

  <!-- Blog Comment Form Section -->
  <section id="blog-comment-form" class="blog-comment-form section">

    <div class="container" data-aos="fade-up" data-aos-delay="100">

      <form id="comment-form" method="post" role=""
        action="{% url 'blog_details' post.slug post.publish.year post.publish.month post.publish.day %}">
        {% csrf_token %}

        <div class="form-header">
          <div id="success-message" class="ms-0 p-3 rounded-3 container bg-success mb-3" style="display: none;">
            <h5 class="text-white text-center">Comment Submitted Successfully</h5>
          </div>
          <div id="error-messsage" class="ms-0 p-3 rounded-3 container bg-danger mb-3" style="display: none;">
            <h5 class="text-white text-center">Comment Submitted Successfully</h5>
          </div>
          <h3>Leave a Comment</h3>
          <p>Your email address will not be published. Required fields are marked *</p>
        </div>

        <div class="row gy-3">
          <div class="col-12">
            <div class="input-group">
              <label for="comment">Your Comment *</label>
              <textarea name="comment" id="comment" rows="5" placeholder="Write your thoughts here..."
                required=""></textarea>
              <span class="error-text">Please enter your comment</span>
            </div>
          </div>

          <div class="col-12 text-center">
            <button id="submit-btn" type="submit">Post Comment</button>
          </div>
        </div>

      </form>

    </div>

  </section><!-- /Blog Comment Form Section -->

</main>
<script>
  <script>
// Wait for the page to fully load before running this code
    document.addEventListener('DOMContentLoaded', function() {
    
    // GET REFERENCES TO HTML ELEMENTS
    const commentForm = document.getElementById('comment-form');  // The form element
    const commentTextarea = document.getElementById('comment');   // The textarea where user types
    const submitBtn = document.getElementById('submit-btn');      // The submit button
    const commentsContainer = document.getElementById('comments-container');  // Where comments appear
    const commentCount = document.getElementById('comment-count'); // The comment counter
    const messageContainer = document.getElementById('message-container'); // For showing messages
    const errorText = document.getElementById('error-text');      // Error message element

    // LISTEN FOR FORM SUBMISSION
    commentForm.addEventListener('submit', function(e) {
      // PREVENT DEFAULT FORM BEHAVIOR
      // This stops the page from refreshing when the form is submitted
      e.preventDefault();

    // GET THE COMMENT TEXT
    const commentText = commentTextarea.value.trim();

    // VALIDATE: Make sure comment is not empty
    if (!commentText) {
      errorText.style.display = 'block';
    return;
        }

    // Hide any previous error messages
    errorText.style.display = 'none';

    // DISABLE SUBMIT BUTTON (prevent multiple submissions)
    submitBtn.disabled = true;
    submitBtn.textContent = 'Posting...';

    // GET THE CSRF TOKEN (required by Django for security)
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // PREPARE THE DATA TO SEND
    const formData = new FormData();
    formData.append('comment', commentText);

    // SEND AJAX REQUEST TO SERVER
    fetch(window.location.href, {  // Send to current page URL
      method: 'POST',            // HTTP method
    body: formData,            // The data we're sending
    headers: {
      'X-CSRFToken': csrfToken,  // Include CSRF token for security
    'X-Requested-With': 'XMLHttpRequest'  // Tells Django this is AJAX
            }
        })
        .then(response => {
            // CHECK IF REQUEST WAS SUCCESSFUL
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
    // CONVERT RESPONSE TO JSON
    return response.json();
        })
        .then(data => {
            // REQUEST SUCCEEDED!
            if (data.status === 'success') {

      // SHOW SUCCESS MESSAGE
      showMessage('Comment posted successfully!', 'success');

    // CREATE NEW COMMENT HTML
    const newCommentHTML = `
    <div class="comment-thread" style="animation: fadeIn 0.5s;">
      <div class="comment-box">
        <div class="comment-wrapper">
          <div class="avatar-wrapper">
            <img src="assets/img/default-avatar.png" alt="Avatar" loading="lazy">
              <span class="status-indicator"></span>
          </div>
          <div class="comment-content">
            <div class="comment-header">
              <div class="user-info">
                <h4>${data.comment.username}</h4>
                <span class="time-badge">
                  <i class="bi bi-clock"></i>
                  Just now
                </span>
              </div>
            </div>
            <div class="comment-body">
              <p>${data.comment.text}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    `;

    // INSERT NEW COMMENT AT THE TOP
    commentsContainer.insertAdjacentHTML('afterbegin', newCommentHTML);

    // UPDATE COMMENT COUNT
    const currentCount = parseInt(commentCount.textContent);
    commentCount.textContent = currentCount + 1;

    // CLEAR THE TEXTAREA
    commentTextarea.value = '';

            } else {
      // Something went wrong on server
      showMessage('Failed to post comment. Please try again.', 'error');
            }
        })
        .catch(error => {
      // HANDLE ANY ERRORS
      console.error('Error:', error);
    showMessage('An error occurred. Please try again.', 'error');
        })
        .finally(() => {
      // RE-ENABLE SUBMIT BUTTON
      // This runs whether the request succeeded or failed
      submitBtn.disabled = false;
    submitBtn.textContent = 'Post Comment';
        });
    });

    // HELPER FUNCTION: Display success/error messages
    function showMessage(message, type) {
      messageContainer.textContent = message;
    messageContainer.style.display = 'block';
    messageContainer.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
    messageContainer.style.color = type === 'success' ? '#155724' : '#721c24';
    messageContainer.style.border = `1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'}`;

        // Hide message after 5 seconds
        setTimeout(() => {
      messageContainer.style.display = 'none';
        }, 5000);
    }
});

    // Optional: Add fade-in animation
    const style = document.createElement('style');
    style.textContent = `
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(-10px); }
    to {opacity: 1; transform: translateY(0); }
    }
    `;
    document.head.appendChild(style);
</script>


{% endblock content %}