{% extends 'base.html' %}

{% load static %}
{% load humanize %}
{% load property_extras %}

{% block content %}

<main class="main">

  <!-- Page Title -->
  <div class="page-title">
    <div class="heading">
      <div class="container">
        <div class="row d-flex justify-content-center text-center">
          <div class="col-lg-8">
            <h1 class="heading-title">Discover Your Dream Property</h1>
            <p class="mb-0">
              Explore our carefully curated collection of premium properties. From modern apartments to luxurious estates, 
              find your perfect home or investment opportunity. Each listing is verified and comes with comprehensive details 
              to help you make informed decisions.
            </p>
          </div>
        </div>
      </div>
    </div>
    <nav class="breadcrumbs">
      <div class="container">
        <ol>
          <li><a href="{% url 'home' %}">Home</a></li>
          <li class="current">Properties</li>
        </ol>
      </div>
    </nav>
  </div><!-- End Page Title -->

  <!-- Properties Section -->
  <section id="properties" class="properties section">

    <div class="container" data-aos="fade-up" data-aos-delay="100">

      <div class="row">
        <div class="col-lg-4" data-aos="fade-up" data-aos-delay="200">

          <div class="properties-sidebar">

            <div class="filter-widget">
              <h5 class="filter-title">Filter Properties</h5>

              <form method="GET" action="{% url 'properties' %}" id="filter-form">
                <!-- Preserve Sort if present -->
                {% if search_params.sort %}
                <input type="hidden" name="sort" value="{{ search_params.sort }}">
                {% endif %}

                <div class="filter-section">
                  <label class="form-label">Property Type</label>
                  <select class="form-select" name="type">
                    <option value="">All Types</option>
                    {% for type in property_types %}
                    <option value="{{ type.name }}" {% if search_params.type == type.name %}selected{% endif %}>{{type.name|title }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="filter-section">
                  <label class="form-label">Price Range</label>
                  <div class="row g-2">
                    <div class="col-6">
                      <input type="number" class="form-control" name="min_price" placeholder="Min Price"
                        value="{{ search_params.min_price|default:'' }}">
                    </div>
                    <div class="col-6">
                      <input type="number" class="form-control" name="max_price" placeholder="Max Price"
                        value="{{ search_params.max_price|default:'' }}">
                    </div>
                  </div>
                </div>

                <div class="filter-section">
                  <label class="form-label">Bedrooms</label>
                  <input type="hidden" name="bedrooms" id="bedrooms_input"
                    value="{{ search_params.bedrooms|default:'Any' }}">
                  <div class="bedroom-filter">
                    <button type="button"
                      class="btn btn-outline-secondary btn-sm filter-btn width-btn {% if not search_params.bedrooms or search_params.bedrooms == 'Any' %}active{% endif %}"
                      data-value="Any" onclick="setFilterValue('bedrooms', 'Any', this)">Any</button>
                    <button type="button"
                      class="btn btn-outline-secondary btn-sm filter-btn width-btn {% if search_params.bedrooms == '1' %}active{% endif %}"
                      data-value="1" onclick="setFilterValue('bedrooms', '1', this)">1</button>
                    <button type="button"
                      class="btn btn-outline-secondary btn-sm filter-btn width-btn {% if search_params.bedrooms == '2' %}active{% endif %}"
                      data-value="2" onclick="setFilterValue('bedrooms', '2', this)">2</button>
                    <button type="button"
                      class="btn btn-outline-secondary btn-sm filter-btn width-btn {% if search_params.bedrooms == '3' %}active{% endif %}"
                      data-value="3" onclick="setFilterValue('bedrooms', '3', this)">3</button>
                    <button type="button"
                      class="btn btn-outline-secondary btn-sm filter-btn width-btn {% if search_params.bedrooms == '4+' %}active{% endif %}"
                      data-value="4+" onclick="setFilterValue('bedrooms', '4+', this)">4+</button>
                  </div>
                </div>

                <div class="filter-section">
                  <label class="form-label">Bathrooms</label>
                  <input type="hidden" name="bathrooms" id="bathrooms_input"
                    value="{{ search_params.bathrooms|default:'Any' }}">
                  <div class="bathroom-filter">
                    <button type="button"
                      class="btn btn-outline-secondary btn-sm filter-btn width-btn {% if not search_params.bathrooms or search_params.bathrooms == 'Any' %}active{% endif %}"
                      data-value="Any" onclick="setFilterValue('bathrooms', 'Any', this)">Any</button>
                    <button type="button"
                      class="btn btn-outline-secondary btn-sm filter-btn width-btn {% if search_params.bathrooms == '1' %}active{% endif %}"
                      data-value="1" onclick="setFilterValue('bathrooms', '1', this)">1</button>
                    <button type="button"
                      class="btn btn-outline-secondary btn-sm filter-btn width-btn {% if search_params.bathrooms == '2' %}active{% endif %}"
                      data-value="2" onclick="setFilterValue('bathrooms', '2', this)">2</button>
                    <button type="button"
                      class="btn btn-outline-secondary btn-sm filter-btn width-btn {% if search_params.bathrooms == '3+' %}active{% endif %}"
                      data-value="3+" onclick="setFilterValue('bathrooms', '3+', this)">3+</button>
                  </div>
                </div>

                <div class="filter-section">
                  <label class="form-label">Location</label>
                  <input type="text" class="form-control" name="location" placeholder="Enter city or neighborhood"
                    value="{{ search_params.location|default:'' }}">
                </div>

                <div class="filter-section">
                  <label class="form-label">Features</label>
                  <div class="features-filter">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="garage" name="garage" {% if 'garage' in search_params %}checked{% endif %}>
                      <label class="form-check-label" for="garage">Garage</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="pool" name="pool" {% if 'pool' in search_params %}checked{% endif %}>
                      <label class="form-check-label" for="pool">Swimming Pool</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="balcony" name="balcony" {% if 'balcony' in search_params %}checked{% endif %}>
                      <label class="form-check-label" for="balcony">Balcony</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="garden" name="garden" {% if 'garden' in search_params %}checked{% endif %}>
                      <label class="form-check-label" for="garden">Garden</label>
                    </div>
                  </div>
                </div>

                <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
              </form>
              <script>
                function setFilterValue(fieldName, value, btn) {
                  document.getElementById(fieldName + '_input').value = value;
                  // Reset active state for siblings
                  let siblings = btn.parentElement.children;
                  for (let i = 0; i < siblings.length; i++) {
                    siblings[i].classList.remove('active');
                  }
                  btn.classList.add('active');
                }
              </script>
            </div>

            <div class="featured-properties mt-4">
              <h5>Featured Properties</h5>

              {% for prop in featured_sidebar %}
              <div class="featured-item mb-3">
                <div class="row g-3 align-items-center">
                  <div class="col-5">
                    <a href="{{ prop.get_absolute_url }}">
                      {% if prop.featured_image %}
                      <img src="{{ prop.featured_image.url }}" alt="{{ prop.title }}" class="img-fluid rounded"
                        style="height: 80px; width: 100%; object-fit: cover;">
                      {% else %}
                      <img src="{% static 'assets/img/real-estate/property-exterior-1.webp' %}" alt="Default Image"
                        class="img-fluid rounded" style="height: 80px; width: 100%; object-fit: cover;">
                      {% endif %}
                    </a>
                  </div>
                  <div class="col-7">
                    <h6 class="mb-1"><a href="{{ prop.get_absolute_url }}" class="text-dark text-decoration-none">{{ prop.title|truncatechars:25 }}</a></h6>
                    <p class="text-muted small mb-1">{{ prop.city.name }}, {{ prop.state.code }}</p>
                    <strong class="text-primary">{{ prop.formatted_price }}</strong>
                  </div>
                </div>
              </div>
              {% empty %}
              <p class="text-muted small">No featured properties available at this time.</p>
              {% endfor %}

            </div>

          </div>

        </div>

        <div class="col-lg-8">

          <div class="properties-header mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
              <div class="view-toggle d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm view-btn active" data-view="grid">
                  <i class="bi bi-grid-3x3-gap"></i> Grid
                </button>
                <button class="btn btn-outline-secondary btn-sm view-btn" data-view="list">
                  <i class="bi bi-list"></i> List
                </button>
              </div>
              <div class="sort-dropdown">
                <form method="GET" class="d-inline-block">
                  <!-- Preserve existing params for sorting -->
                  {% for key, value in search_params.items %}
                  {% if key != 'sort' and key != 'page' %}
                  <input type="hidden" name="{{ key }}" value="{{ value }}">
                  {% endif %}
                  {% endfor %}

                  <select class="form-select form-select-sm" name="sort" onchange="this.form.submit()">
                    <option value="newest" {% if search_params.sort == 'newest' %}selected{% endif %}>Sort by: Newest
                    </option>
                    <option value="price_asc" {% if search_params.sort == 'price_asc' %}selected{% endif %}>Price: Low to
                      High</option>
                    <option value="price_desc" {% if search_params.sort == 'price_desc' %}selected{% endif %}>Price: High
                      to Low</option>
                    <option value="views" {% if search_params.sort == 'views' %}selected{% endif %}>Most Viewed</option>
                  </select>
                </form>
              </div>
            </div>
          </div>

          <div class="properties-grid view-grid active" data-aos="fade-up" data-aos-delay="200">
            <div class="row g-4">

              {% for prop in properties %}
              <div class="col-lg-6 col-md-6">
                <div class="property-card">
                  <div class="property-image">
                    {% if prop.featured_image %}
                    <img src="{{ prop.featured_image.url }}" alt="{{ prop.title }}" class="img-fluid"
                      style="height: 300px; object-fit: cover; width: 100%;">
                    {% else %}
                    <img src="{% static 'assets/img/real-estate/property-exterior-1.webp' %}" alt="Default Image"
                      class="img-fluid" style="height: 300px; object-fit: cover; width: 100%;">
                    {% endif %}

                    <div class="property-badges">
                      {% if prop.is_featured %}
                      <span class="badge featured">Featured</span>
                      {% endif %}
                      <span
                        class="badge {% if prop.status.name == 'for_rent' %}for-rent{% else %}for-sale{% endif %}">{{ prop.status.get_name_display }}</span>
                    </div>

                    <div class="property-overlay">
                      <button class="favorite-btn"><i class="bi bi-heart"></i></button>
                      <button class="gallery-btn" data-count="{{ prop.images.count }}"><i class="bi bi-images"></i></button>
                    </div>
                  </div>
                  <div class="property-content">
                    <div class="property-price">{{ prop.formatted_price }}{% if prop.status.name == 'for_rent' %}<span>/month</span>{% endif %}</div>
                    <h4 class="property-title"><a href="{{ prop.get_absolute_url }}">{{ prop.title }}</a></h4>
                    <p class="property-location"><i class="bi bi-geo-alt"></i> {{ prop.address }}, {{ prop.city.name }},
                      {{ prop.state.code }}</p>
                    <div class="property-features">
                      <span><i class="bi bi-house"></i> {{ prop.bedrooms }} Bed</span>
                      <span><i class="bi bi-water"></i> {{ prop.bathrooms }} Bath</span>
                      <span><i class="bi bi-arrows-angle-expand"></i> {{ prop.square_feet|intcomma }} sqft</span>
                    </div>
                    <div class="property-agent">
                      <div class="agent-info">
                        <strong>{{ prop.listed_by.get_full_name|default:prop.listed_by.username }}</strong>
                      </div>
                    </div>
                    <a href="{{ prop.get_absolute_url }}" class="btn btn-primary w-100">View Details</a>
                  </div>
                </div>
              </div><!-- End Property Item -->
              {% empty %}
              <div class="col-12 text-center py-5">
                <h3>No Properties Found</h3>
                <p class="text-muted">We couldn't find any properties matching your criteria. Try adjusting your filters or browse all available properties.</p>
              </div>
              {% endfor %}

            </div>
          </div>

          <div class="properties-list view-list" data-aos="fade-up" data-aos-delay="200">

            {% for prop in properties %}
            <div class="property-list-item">
              <div class="row align-items-center">
                <div class="col-lg-4">
                  <div class="property-image">
                    {% if prop.featured_image %}
                    <img src="{{ prop.featured_image.url }}" alt="{{ prop.title }}" class="img-fluid"
                      style="height: 250px; object-fit: cover; width: 100%;">
                    {% else %}
                    <img src="{% static 'assets/img/real-estate/property-exterior-1.webp' %}" alt="Default Image"
                      class="img-fluid">
                    {% endif %}
                    <div class="property-badges">
                      {% if prop.is_featured %}
                      <span class="badge featured">Featured</span>
                      {% endif %}
                      <span
                        class="badge {% if prop.status.name == 'for_rent' %}for-rent{% else %}for-sale{% endif %}">{{
                        prop.status.name|title|default:prop.status }}</span>
                    </div>
                  </div>
                </div>
                <div class="col-lg-8">
                  <div class="property-content">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <h4 class="property-title mb-1"><a href="{{ prop.get_absolute_url }}">{{ prop.title }}</a></h4>
                        <p class="property-location mb-2"><i class="bi bi-geo-alt"></i> {{ prop.address }}, {{
                          prop.city.name }}, {{ prop.state.code }}</p>
                      </div>
                      <div class="property-price">{{ prop.formatted_price }}</div>
                    </div>
                    <div class="property-features mb-3">
                      <span><i class="bi bi-house"></i> {{ prop.bedrooms }} Bed</span>
                      <span><i class="bi bi-water"></i> {{ prop.bathrooms }} Bath</span>
                      <span><i class="bi bi-arrows-angle-expand"></i> {{ prop.square_feet|intcomma }} sqft</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="property-agent">
                        <span>{{ prop.listed_by.get_full_name|default:prop.listed_by.username }}</span>
                      </div>
                      <div class="property-actions">
                        <button class="btn btn-outline-secondary btn-sm"><i class="bi bi-heart"></i></button>
                        <a href="{{ prop.get_absolute_url }}" class="btn btn-primary btn-sm">View Details</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div><!-- End Property List Item -->
            {% empty %}
            <div class="text-center py-5">
              <h4>No Properties Available</h4>
              <p class="text-muted">Check back soon for new listings or modify your search criteria.</p>
            </div>
            {% endfor %}

          </div>

          <nav class="mt-5" data-aos="fade-up" data-aos-delay="300">
            <ul class="pagination justify-content-center">
              {% if properties.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?{% url_replace page=properties.previous_page_number %}"
                  tabindex="-1">Previous</a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1">Previous</a>
              </li>
              {% endif %}

              {% for num in properties.paginator.page_range %}
              {% if properties.number == num %}
              <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
              {% elif num > properties.number|add:'-3' and num < properties.number|add:'3' %}
              <li class="page-item"><a class="page-link" href="?{% url_replace page=num %}">{{ num }}</a></li>
              {% endif %}
              {% endfor %}

              {% if properties.has_next %}
              <li class="page-item">
                <a class="page-link" href="?{% url_replace page=properties.next_page_number %}">Next</a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <a class="page-link" href="#">Next</a>
              </li>
              {% endif %}
            </ul>
          </nav>

        </div>

        

      </div>

    </div>

  </section><!-- /Properties Section -->

</main>
{% endblock content %}

<footer id="footer" class="footer position-relative">

  <div class="container">
    <div class="row gy-5">

      <div class="col-lg-4">
        <div class="footer-content">
          <a href="{% url 'home' %}" class="logo d-flex align-items-center mb-4">
            <span class="sitename">Nestova</span>
          </a>
          <p class="mb-4">Your trusted partner in finding the perfect property. We specialize in connecting buyers, sellers, and renters with exceptional real estate opportunities. Our commitment to excellence and personalized service ensures your property journey is smooth and successful.</p>

          <div class="newsletter-form">
            <h5>Stay Updated</h5>
            <form action="forms/newsletter.php" method="post" class="php-email-form">
              <div class="input-group">
                <input type="email" name="email" class="form-control" placeholder="Enter your email" required="">
                <button type="submit" class="btn-subscribe">
                  <i class="bi bi-send"></i>
                </button>
              </div>
              <div class="loading">Loading</div>
              <div class="error-message"></div>
              <div class="sent-message">Thank you for subscribing!</div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-2 col-6">
        <div class="footer-links">
          <h4>Company</h4>
          <ul>
            <li><a href="{% url 'about' %}"><i class="bi bi-chevron-right"></i> About Us</a></li>
            <li><a href="{% url 'agents' %}"><i class="bi bi-chevron-right"></i> Our Agents</a></li>
            <li><a href="{% url 'service' %}"><i class="bi bi-chevron-right"></i> Services</a></li>
            <li><a href="{% url 'blog:list' %}"><i class="bi bi-chevron-right"></i> Blog</a></li>
            <li><a href="{% url 'contact' %}"><i class="bi bi-chevron-right"></i> Contact</a></li>
          </ul>
        </div>
      </div>

      <div class="col-lg-2 col-6">
        <div class="footer-links">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="{% url 'properties' %}"><i class="bi bi-chevron-right"></i> Browse Properties</a></li>
            <li><a href="{% url 'apartment_list' %}"><i class="bi bi-chevron-right"></i> Apartments</a></li>
            <li><a href="{% url 'agents_signup' %}"><i class="bi bi-chevron-right"></i> Become An Agent</a></li>
            <li><a href="{% url 'shop:profile' %}"><i class="bi bi-chevron-right"></i> My Dashboard</a></li>
            <li><a href="{% url 'shop:cart' %}"><i class="bi bi-chevron-right"></i> My Cart</a></li>
          </ul>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="footer-contact">
          <h4>Get in Touch</h4>
          <div class="contact-item">
            <div class="contact-icon">
              <i class="bi bi-geo-alt"></i>
            </div>
            <div class="contact-info">
              <p>123 Real Estate Avenue<br>Port Harcourt, Rivers State<br>Nigeria</p>
            </div>
          </div>

          <div class="contact-item">
            <div class="contact-icon">
              <i class="bi bi-telephone"></i>
            </div>
            <div class="contact-info">
              <p>+234 (0) 800 123 4567</p>
            </div>
          </div>

          <div class="contact-item">
            <div class="contact-icon">
              <i class="bi bi-envelope"></i>
            </div>
            <div class="contact-info">
              <p>info@nestova.com</p>
            </div>
          </div>

          <div class="social-links">
            <a href="#"><i class="bi bi-facebook"></i></a>
            <a href="#"><i class="bi bi-twitter-x"></i></a>
            <a href="#"><i class="bi bi-linkedin"></i></a>
            <a href="#"><i class="bi bi-instagram"></i></a>
            <a href="#"><i class="bi bi-whatsapp"></i></a>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="footer-bottom">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-6">
          <div class="copyright">
            <p>Â© <span>Copyright {{ current_year|default:"2025" }}</span> <strong class="px-1 sitename">Nestova</strong> <span>All Rights Reserved</span></p>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="footer-bottom-links">
            <a href="#">Privacy Policy</a>
            <a href="#">Terms of Service</a>
            <a href="#">Cookie Policy</a>
          </div>
        </div>
      </div>
    </div>
  </div>

</footer>

<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
    class="bi bi-arrow-up-short"></i></a>

<!-- Preloader -->
<div id="preloader"></div>

<!-- Vendor JS Files -->
<script src="{% static 'assets/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'assets/vendor/php-email-form/validate.js' %}"></script>
<script src="{% static 'assets/vendor/aos/aos.js' %}"></script>
<script src="{% static 'assets/vendor/purecounter/purecounter_vanilla.js' %}"></script>
<script src="{% static 'assets/vendor/glightbox/js/glightbox.min.js' %}"></script>
<script src="{% static 'assets/vendor/swiper/swiper-bundle.min.js' %}"></script>
<script src="{% static 'assets/vendor/drift-zoom/Drift.min.js' %}"></script>

<!-- Main JS File -->
<script src="{% static 'assets/js/main.js' %}"></script>

</body>

</html>