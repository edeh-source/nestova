{% extends 'base.html' %}

{% load static %}
{% load humanize %}
{% load property_extras %}
{% load embed_video_tags %}

{% block seo_meta %}
{% include 'includes/seo_meta.html' %}
{% endblock seo_meta %}

{% block title %}{{ property.title }} - {{ property.status.get_name_display }} in {{ property.city.name }} | Nestova{% endblock %}

{% block extra_head %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "RealEstateListing",
  "name": "{{ property.title|escapejs }}",
  "description": "{{ property.description|striptags|truncatewords:50|escapejs }}",
  "url": "{{ request.build_absolute_uri }}",
  "image": "{% if property.featured_image %}{{ request.scheme }}://{{ request.get_host }}{{ property.featured_image.url }}{% endif %}",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "{{ property.address|escapejs }}",
    "addressLocality": "{{ property.city.name|escapejs }}",
    "addressRegion": "{{ property.state.name|escapejs }}",
    "addressCountry": "NG"
  },
  "offers": {
    "@type": "Offer",
    "price": "{{ property.price }}",
    "priceCurrency": "NGN",
    "availability": "https://schema.org/InStock",
    "url": "{{ request.build_absolute_uri }}"
  },
  "numberOfRooms": "{{ property.bedrooms }}",
  "numberOfBathroomsTotal": "{{ property.bathrooms }}",
  "floorSize": { "@type": "QuantitativeValue", "value": "{{ property.square_feet }}", "unitCode": "FTK" }
  {% if property.year_built %},"yearBuilt": "{{ property.year_built }}"{% endif %}
}
</script>

<style>
/* ============================================================
   PROPERTY DETAIL — LUXURY GLASSMORPHISM SYSTEM
   ============================================================ */

/* ---- PAGE HERO ---- */
.prop-hero {
  position: relative;
  margin-top: 80px;
  padding: 70px 0 56px;
  overflow: hidden;
  background: linear-gradient(160deg, #060B1A 0%, #0D1B3E 55%, #0A0A0F 100%);
}

.prop-hero::before {
  content: '';
  position: absolute;
  width: 800px; height: 800px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(201,168,76,0.07), transparent 65%);
  top: -300px; right: -200px;
  pointer-events: none;
}

.prop-hero::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(to right, transparent, rgba(201,168,76,0.3), transparent);
}

.prop-hero-grain {
  position: absolute; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
  pointer-events: none; opacity: 0.5;
}

.prop-hero-content { position: relative; z-index: 2; }

.prop-hero-badges {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

.prop-eyebrow {
  display: inline-flex;
  align-items: center;
  gap: 7px;
  padding: 7px 16px;
  border-radius: 50px;
  background: linear-gradient(135deg, rgba(201,168,76,0.15), rgba(201,168,76,0.05));
  border: 1px solid rgba(201,168,76,0.3);
  color: var(--gold);
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.18em;
  text-transform: uppercase;
}

.prop-status-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 16px;
  border-radius: 50px;
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  backdrop-filter: blur(12px);
  border: 1px solid transparent;
}

.prop-status-pill.for-sale {
  background: rgba(30,140,80,0.18);
  border-color: rgba(60,200,110,0.35);
  color: #6DFFA8;
}

.prop-status-pill.for-rent {
  background: rgba(30,100,200,0.18);
  border-color: rgba(60,130,255,0.35);
  color: #7EB8FF;
}

.prop-hero h1 {
  font-family: var(--font-display);
  font-size: clamp(1.8rem, 4vw, 3.2rem);
  font-weight: 300;
  color: #fff;
  line-height: 1.15;
  margin-bottom: 14px;
  letter-spacing: -0.5px;
}

.prop-hero-meta {
  display: flex;
  align-items: center;
  gap: 20px;
  color: rgba(255,255,255,0.45);
  font-size: 0.88rem;
  flex-wrap: wrap;
  margin-bottom: 24px;
}

.prop-hero-meta span {
  display: flex;
  align-items: center;
  gap: 6px;
}

.prop-hero-meta i { color: var(--gold); }

.breadcrumbs-glass {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 9px 18px;
  background: rgba(255,255,255,0.05);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 50px;
  font-size: 0.8rem;
}

.breadcrumbs-glass a { color: rgba(255,255,255,0.45); text-decoration: none; transition: color 0.3s; }
.breadcrumbs-glass a:hover { color: var(--gold-light); }
.breadcrumbs-glass .sep { color: rgba(255,255,255,0.18); font-size: 0.7rem; }
.breadcrumbs-glass .current { color: var(--gold-light); font-weight: 500; }

/* ============================================================
   MAIN LAYOUT
   ============================================================ */
.detail-section {
  padding: 52px 0 100px;
  background: var(--obsidian);
}

/* Glass panel utility */
.glass-panel {
  background: rgba(18,18,26,0.85);
  backdrop-filter: blur(24px) saturate(160%);
  -webkit-backdrop-filter: blur(24px) saturate(160%);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 20px;
  padding: 32px;
  margin-bottom: 24px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.glass-panel-title {
  font-family: var(--font-body);
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--gold);
  font-weight: 700;
  margin-bottom: 22px;
  padding-bottom: 14px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ============================================================
   GALLERY
   ============================================================ */
.property-gallery { margin-bottom: 24px; }

.main-image-container {
  position: relative;
  border-radius: 20px;
  overflow: hidden;
  background: rgba(18,18,26,0.8);
  border: 1px solid rgba(255,255,255,0.07);
  margin-bottom: 14px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
}

.main-property-image {
  width: 100%;
  height: 480px;
  object-fit: cover;
  display: block;
  transition: transform 0.5s ease;
  cursor: zoom-in;
}

.main-property-image:hover { transform: scale(1.02); }

/* Gallery overlay nav */
.image-nav-buttons {
  position: absolute;
  top: 50%;
  left: 0; right: 0;
  transform: translateY(-50%);
  display: flex;
  justify-content: space-between;
  padding: 0 16px;
  pointer-events: none;
  z-index: 3;
}

.image-nav-btn {
  pointer-events: all;
  width: 48px; height: 48px;
  border-radius: 50%;
  background: rgba(10,10,15,0.65);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255,255,255,0.12);
  color: #fff;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.image-nav-btn:hover {
  background: var(--gold);
  color: #0A0A0F;
  border-color: var(--gold);
  transform: scale(1.1);
}

/* Image count badge */
.img-count-badge {
  position: absolute;
  bottom: 16px; right: 16px;
  padding: 6px 14px;
  background: rgba(10,10,15,0.7);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 50px;
  color: rgba(255,255,255,0.7);
  font-size: 0.78rem;
  font-weight: 500;
  display: flex; align-items: center; gap: 6px;
  z-index: 3;
}

.img-count-badge i { color: var(--gold); }

/* Thumbnails */
.thumbnail-gallery {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.thumbnail-item {
  width: 80px; height: 60px;
  border-radius: 10px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid rgba(255,255,255,0.05);
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.thumbnail-item img {
  width: 100%; height: 100%;
  object-fit: cover;
  transition: transform 0.4s ease;
}

.thumbnail-item:hover { border-color: rgba(201,168,76,0.4); transform: translateY(-2px); }
.thumbnail-item:hover img { transform: scale(1.1); }
.thumbnail-item.active { border-color: var(--gold); box-shadow: 0 4px 16px rgba(201,168,76,0.2); }

/* ============================================================
   DESCRIPTION
   ============================================================ */
.property-description h3,
.property-amenities h3,
.property-video h3 {
  display: none; /* replaced by glass-panel-title */
}

.property-description .desc-body {
  color: rgba(255,255,255,0.55);
  font-size: 0.95rem;
  line-height: 1.8;
}

.property-description .desc-body p { margin-bottom: 14px; }

/* ============================================================
   AMENITIES
   ============================================================ */
.amenity-subhead {
  font-size: 0.7rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.3);
  font-weight: 600;
  margin-bottom: 14px;
}

.features-list {
  list-style: none;
  padding: 0; margin: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.features-list li {
  display: flex;
  align-items: center;
  gap: 12px;
  color: rgba(255,255,255,0.65);
  font-size: 0.9rem;
  padding: 10px 14px;
  border-radius: 10px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.04);
  transition: all 0.3s ease;
}

.features-list li:hover {
  background: rgba(201,168,76,0.06);
  border-color: rgba(201,168,76,0.15);
  color: rgba(255,255,255,0.85);
  transform: translateX(4px);
}

.features-list li i {
  color: var(--gold);
  font-size: 1rem;
  flex-shrink: 0;
}

/* ============================================================
   VIDEO
   ============================================================ */
.video-frame-wrap {
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.07);
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
}

.video-frame-wrap iframe {
  display: block;
  width: 100%;
}

/* ============================================================
   SIDEBAR — STICKY OVERVIEW
   ============================================================ */
.prop-sidebar {
  position: sticky;
  top: 100px;
}

/* Price card */
.price-card {
  background: rgba(18,18,26,0.9);
  backdrop-filter: blur(28px) saturate(180%);
  -webkit-backdrop-filter: blur(28px) saturate(180%);
  border: 1px solid rgba(201,168,76,0.2);
  border-radius: 20px;
  padding: 28px;
  margin-bottom: 16px;
  box-shadow: 0 30px 70px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.06);
}

.price-display {
  font-family: var(--font-display);
  font-size: 2.4rem;
  font-weight: 600;
  color: var(--gold-light);
  line-height: 1;
  margin-bottom: 4px;
  display: flex;
  align-items: baseline;
  gap: 8px;
}

.price-display small {
  font-family: var(--font-body);
  font-size: 0.85rem;
  color: rgba(255,255,255,0.3);
  font-weight: 400;
}

.price-status {
  display: inline-flex;
  align-items: center;
  padding: 5px 14px;
  border-radius: 50px;
  font-size: 0.72rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 18px;
  margin-top: 8px;
}

.price-status.for-rent {
  background: rgba(30,100,200,0.18);
  border: 1px solid rgba(60,130,255,0.35);
  color: #7EB8FF;
}

.price-status.for-sale {
  background: rgba(30,140,80,0.18);
  border: 1px solid rgba(60,200,110,0.35);
  color: #6DFFA8;
}

/* Address */
.prop-address {
  padding: 14px 0;
  border-top: 1px solid rgba(255,255,255,0.06);
  border-bottom: 1px solid rgba(255,255,255,0.06);
  margin-bottom: 20px;
}

.prop-address h4 {
  font-size: 0.95rem;
  font-weight: 500;
  color: rgba(255,255,255,0.8);
  margin-bottom: 4px;
}

.prop-address p {
  font-size: 0.83rem;
  color: rgba(255,255,255,0.35);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 6px;
}

.prop-address p i { color: var(--gold); }

/* Stats grid */
.prop-stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.prop-stat {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px;
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all 0.3s ease;
}

.prop-stat:hover {
  background: rgba(201,168,76,0.07);
  border-color: rgba(201,168,76,0.18);
}

.prop-stat-icon {
  width: 36px; height: 36px;
  border-radius: 10px;
  background: rgba(201,168,76,0.1);
  border: 1px solid rgba(201,168,76,0.2);
  display: flex; align-items: center; justify-content: center;
  color: var(--gold);
  font-size: 1rem;
  flex-shrink: 0;
}

.prop-stat-value {
  font-family: var(--font-display);
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1;
  display: block;
}

.prop-stat-label {
  font-size: 0.72rem;
  color: rgba(255,255,255,0.3);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  display: block;
  margin-top: 2px;
}

/* Action messages */
.action-msg {
  padding: 12px 18px;
  border-radius: 12px;
  font-size: 0.88rem;
  font-weight: 500;
  margin-bottom: 14px;
  display: none;
}

.action-msg.success {
  background: rgba(30,140,80,0.15);
  border: 1px solid rgba(60,200,110,0.3);
  color: #6DFFA8;
}

.action-msg.error {
  background: rgba(220,50,50,0.15);
  border: 1px solid rgba(220,50,50,0.3);
  color: #ff8a8a;
}

/* Buttons */
.btn-save {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  font-family: var(--font-body);
  font-weight: 700;
  font-size: 0.9rem;
  letter-spacing: 0.04em;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  border: none;
  margin-bottom: 10px;
}

.btn-save-primary {
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  color: #0A0A0F;
  box-shadow: 0 6px 20px rgba(201,168,76,0.25);
}

.btn-save-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(201,168,76,0.4);
  color: #0A0A0F;
}

.btn-save-saved {
  background: rgba(30,140,80,0.15);
  border: 1px solid rgba(60,200,110,0.3);
  color: #6DFFA8;
}

.btn-save-login {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.7);
}

.btn-save-login:hover {
  background: rgba(255,255,255,0.1);
  color: #fff;
}

/* ============================================================
   AGENT CARD
   ============================================================ */
.agent-card {
  background: rgba(18,18,26,0.85);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 20px;
  padding: 24px;
  margin-bottom: 16px;
}

.agent-card-header {
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--gold);
  font-weight: 700;
  margin-bottom: 18px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.agent-profile-row {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 18px;
}

.agent-avatar {
  width: 64px; height: 64px;
  border-radius: 50%;
  overflow: hidden;
  border: 2px solid rgba(201,168,76,0.3);
  flex-shrink: 0;
}

.agent-avatar img {
  width: 100%; height: 100%;
  object-fit: cover;
}

.agent-name {
  font-size: 1rem;
  font-weight: 600;
  color: rgba(255,255,255,0.9);
  text-decoration: none;
  transition: color 0.3s;
  display: block;
  margin-bottom: 3px;
}

.agent-name:hover { color: var(--gold-light); }

.agent-role {
  font-size: 0.78rem;
  color: rgba(255,255,255,0.35);
  display: block;
  margin-bottom: 6px;
}

.badge-verified {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 12px;
  border-radius: 50px;
  background: rgba(30,140,80,0.15);
  border: 1px solid rgba(60,200,110,0.3);
  color: #6DFFA8;
  font-size: 0.68rem;
  font-weight: 700;
  letter-spacing: 0.08em;
}

.btn-agent-props {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 11px 18px;
  border-radius: 12px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.09);
  color: rgba(255,255,255,0.65);
  font-size: 0.83rem;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.3s ease;
  width: 100%;
  justify-content: center;
}

.btn-agent-props:hover {
  background: rgba(201,168,76,0.1);
  border-color: rgba(201,168,76,0.25);
  color: var(--gold-light);
}

/* ============================================================
   REFERRAL CARD
   ============================================================ */
.referral-card {
  background: linear-gradient(135deg, rgba(13,27,62,0.8), rgba(18,18,26,0.7));
  border: 1px solid rgba(201,168,76,0.2);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
}

.referral-card h5 {
  font-family: var(--font-body);
  font-size: 0.83rem;
  font-weight: 700;
  color: var(--gold-light);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 7px;
}

.referral-card p {
  font-size: 0.8rem;
  color: rgba(255,255,255,0.4);
  margin-bottom: 14px;
}

.referral-input-wrap {
  display: flex;
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.04);
}

.referral-input-wrap input {
  flex: 1;
  background: transparent;
  border: none;
  padding: 10px 14px;
  color: rgba(255,255,255,0.65);
  font-size: 0.82rem;
  outline: none;
  font-family: var(--font-body);
}

.btn-copy-ref {
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  border: none;
  color: #0A0A0F;
  padding: 10px 16px;
  font-size: 0.8rem;
  font-weight: 700;
  cursor: pointer;
  display: flex; align-items: center; gap: 6px;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.btn-copy-ref:hover { background: linear-gradient(135deg, var(--gold-light), var(--gold)); }

/* ============================================================
   SHARE SECTION
   ============================================================ */
.share-card {
  background: rgba(18,18,26,0.85);
  backdrop-filter: blur(24px);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 20px;
  padding: 22px 24px;
  margin-bottom: 16px;
}

.share-label {
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.3);
  font-weight: 600;
  margin-bottom: 14px;
}

.share-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.share-btn {
  width: 44px; height: 44px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem;
  text-decoration: none;
  transition: all 0.3s ease;
  cursor: pointer;
  border: 1px solid rgba(255,255,255,0.07);
  background: rgba(255,255,255,0.04);
  color: rgba(255,255,255,0.55);
}

.share-btn:hover { transform: translateY(-3px); }

.share-btn.facebook:hover { background: rgba(24,119,242,0.2); border-color: rgba(24,119,242,0.4); color: #4A9FFF; }
.share-btn.twitter:hover  { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.25); color: #fff; }
.share-btn.whatsapp:hover { background: rgba(37,211,102,0.2); border-color: rgba(37,211,102,0.4); color: #25D366; }
.share-btn.linkedin:hover { background: rgba(0,119,181,0.2); border-color: rgba(0,119,181,0.4); color: #0A8FDC; }
.share-btn.email:hover    { background: rgba(201,168,76,0.15); border-color: rgba(201,168,76,0.3); color: var(--gold-light); }
.share-btn.copy-link:hover { background: rgba(201,168,76,0.15); border-color: rgba(201,168,76,0.3); color: var(--gold-light); }
.share-btn.copied { background: rgba(30,140,80,0.2); border-color: rgba(60,200,110,0.4); color: #6DFFA8; }

.become-agent-link {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--gold);
  font-size: 0.82rem;
  font-weight: 600;
  text-decoration: none;
  margin-top: 14px;
  transition: color 0.3s;
}

.become-agent-link:hover { color: var(--gold-light); }

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media (max-width: 1199px) {
  .prop-sidebar { position: static; }
}

@media (max-width: 991px) {
  .main-property-image { height: 360px; }
  .prop-hero h1 { font-size: 2rem; }
  .glass-panel { padding: 24px; }
  .price-display { font-size: 2rem; }
}

@media (max-width: 767px) {
  .prop-hero { padding: 60px 0 44px; }
  .main-property-image { height: 280px; }
  .thumbnail-item { width: 64px; height: 50px; }
  .prop-stats-grid { grid-template-columns: repeat(2, 1fr); }
  .glass-panel { padding: 20px; }
  .price-card { padding: 22px; }
  .prop-hero-meta { gap: 14px; }
}

@media (max-width: 575px) {
  .main-property-image { height: 240px; }
  .prop-stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .share-buttons { gap: 6px; }
  .share-btn { width: 40px; height: 40px; font-size: 0.9rem; }
}
</style>
{% endblock extra_head %}

{% block content %}
<main class="main">

  <!-- ======================== PAGE HERO ======================== -->
  <div class="prop-hero">
    <div class="prop-hero-grain"></div>
    <div class="container">
      <div class="prop-hero-content">
        <div class="prop-hero-badges">
          <div class="prop-eyebrow"><i class="bi bi-gem"></i> Property Details</div>
          <div class="prop-status-pill {% if property.status.name == 'for_rent' %}for-rent{% else %}for-sale{% endif %}">
            <i class="bi bi-circle-fill" style="font-size:0.5rem;"></i>
            {{ property.status.get_name_display }}
          </div>
          {% if property.is_featured %}
          <div class="prop-eyebrow" style="background:rgba(201,168,76,0.2);border-color:rgba(201,168,76,0.5);">
            <i class="bi bi-star-fill"></i> Featured
          </div>
          {% endif %}
        </div>

        <h1>{{ property.title }}</h1>

        <div class="prop-hero-meta">
          <span><i class="bi bi-geo-alt-fill"></i> {{ property.address }}, {{ property.city.name }}, {{ property.state.name }}</span>
          <span><i class="bi bi-door-open"></i> {{ property.bedrooms }} Bed</span>
          <span><i class="bi bi-droplet"></i> {{ property.bathrooms }} Bath</span>
          <span><i class="bi bi-aspect-ratio"></i> {{ property.square_feet|intcomma }} sq ft</span>
        </div>

        <div class="breadcrumbs-glass">
          <a href="{% url 'home' %}">Home</a>
          <span class="sep"><i class="bi bi-chevron-right"></i></span>
          <a href="{% url 'properties' %}">Properties</a>
          <span class="sep"><i class="bi bi-chevron-right"></i></span>
          <span class="current">{{ property.title|truncatechars:40 }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================== DETAIL SECTION ======================== -->
  <section class="detail-section">
    <div class="container">
      <div class="row gy-4">

        <!-- ======================== LEFT COLUMN ======================== -->
        <div class="col-lg-8">

          <!-- Gallery -->
          <div class="property-gallery">
            <div class="main-image-container image-zoom-container">
              {% if property.featured_image %}
              <img id="main-product-image" src="{{ property.featured_image.url }}" alt="{{ property.title }}" class="main-property-image" data-zoom="{{ property.featured_image.url }}">
              {% else %}
              <img id="main-product-image" src="{% static 'assets/img/real-estate/property-exterior-3.webp' %}" alt="{{ property.title }}" class="main-property-image">
              {% endif %}

              <div class="image-nav-buttons">
                <button class="image-nav-btn prev-image" type="button"><i class="bi bi-chevron-left"></i></button>
                <button class="image-nav-btn next-image" type="button"><i class="bi bi-chevron-right"></i></button>
              </div>

              <div class="img-count-badge">
                <i class="bi bi-images"></i>
                <span id="imgCounter">1 / {{ property.images.count|add:1 }}</span>
              </div>
            </div>

            <div class="thumbnail-gallery thumbnail-list">
              {% if property.featured_image %}
              <div class="thumbnail-item active" data-image="{{ property.featured_image.url }}">
                <img src="{{ property.featured_image.url }}" alt="{{ property.title }}">
              </div>
              {% endif %}

              {% for image in property.images.all %}
              <div class="thumbnail-item" data-image="{{ image.image.url }}">
                <img src="{{ image.image.url }}" alt="{{ image.caption|default:property.title }}">
              </div>
              {% empty %}
              {% if not property.featured_image %}
              <div class="thumbnail-item active" data-image="{% static 'assets/img/real-estate/property-exterior-3.webp' %}">
                <img src="{% static 'assets/img/real-estate/property-exterior-3.webp' %}" alt="Property">
              </div>
              {% endif %}
              {% endfor %}
            </div>
          </div>

          <!-- About -->
          <div class="glass-panel">
            <div class="glass-panel-title"><i class="bi bi-file-text"></i> About This Property</div>
            <div class="desc-body" style="color:rgba(255,255,255,0.55);font-size:0.95rem;line-height:1.8;">
              {{ property.description|safe }}
            </div>
          </div>

          <!-- Amenities -->
          <div class="glass-panel">
            <div class="glass-panel-title"><i class="bi bi-house-gear"></i> Amenities &amp; Features</div>
            <div class="row g-4">
              <div class="col-md-6">
                <div class="amenity-subhead">Property Features</div>
                <ul class="features-list">
                  {% if property.has_garage %}<li><i class="bi bi-check-circle-fill"></i>Garage</li>{% endif %}
                  {% if property.has_pool %}<li><i class="bi bi-check-circle-fill"></i>Swimming Pool</li>{% endif %}
                  {% if property.has_garden %}<li><i class="bi bi-check-circle-fill"></i>Garden</li>{% endif %}
                  {% if property.has_security %}<li><i class="bi bi-check-circle-fill"></i>Security System</li>{% endif %}
                  {% if property.has_gym %}<li><i class="bi bi-check-circle-fill"></i>Gym</li>{% endif %}
                  {% if property.has_balcony %}<li><i class="bi bi-check-circle-fill"></i>Balcony / Patio</li>{% endif %}
                  {% if property.is_furnished %}<li><i class="bi bi-check-circle-fill"></i>Furnished</li>{% endif %}
                  {% if property.has_ac %}<li><i class="bi bi-check-circle-fill"></i>Air Conditioning</li>{% endif %}
                  {% if property.has_heating %}<li><i class="bi bi-check-circle-fill"></i>Heating</li>{% endif %}
                </ul>
              </div>

              {% if property.additional_features %}
              <div class="col-md-6">
                <div class="amenity-subhead">Additional Details</div>
                <ul class="features-list">
                  {% for key, value in property.additional_features.items %}
                  <li><i class="bi bi-check-circle-fill"></i>{{ key }}: {{ value }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Video -->
          {% if property.video_url %}
          <div class="glass-panel">
            <div class="glass-panel-title"><i class="bi bi-play-circle"></i> Property Video Tour</div>
            <div class="video-frame-wrap">
              <div class="ratio ratio-16x9">
                <iframe src="https://www.youtube-nocookie.com/embed/{{ property.video_url|youtube_id }}?rel=0&modestbranding=1"
                  title="Property Video Tour" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen>
                </iframe>
              </div>
            </div>
          </div>
          {% endif %}

        </div>

        <!-- ======================== RIGHT SIDEBAR ======================== -->
        <div class="col-lg-4">
          <div class="prop-sidebar">

            <!-- Price Card -->
            <div class="price-card">
              <div class="price-display">
                {{ property.formatted_price }}
                {% if property.status.name == 'for_rent' %}<small>/mo</small>{% endif %}
              </div>
              <div class="price-status {% if property.status.name == 'for_rent' %}for-rent{% else %}for-sale{% endif %}">
                {{ property.status.get_name_display }}
              </div>

              <div class="prop-address">
                <h4>{{ property.address }}</h4>
                <p><i class="bi bi-geo-alt-fill"></i> {{ property.city.name }}, {{ property.state.name }}</p>
              </div>

              <!-- Stats -->
              <div class="prop-stats-grid">
                <div class="prop-stat">
                  <div class="prop-stat-icon"><i class="bi bi-door-open"></i></div>
                  <div>
                    <span class="prop-stat-value">{{ property.bedrooms }}</span>
                    <span class="prop-stat-label">Bedrooms</span>
                  </div>
                </div>
                <div class="prop-stat">
                  <div class="prop-stat-icon"><i class="bi bi-droplet"></i></div>
                  <div>
                    <span class="prop-stat-value">{{ property.bathrooms }}</span>
                    <span class="prop-stat-label">Bathrooms</span>
                  </div>
                </div>
                <div class="prop-stat">
                  <div class="prop-stat-icon"><i class="bi bi-aspect-ratio"></i></div>
                  <div>
                    <span class="prop-stat-value">{{ property.square_feet|intcomma }}</span>
                    <span class="prop-stat-label">Sq Ft</span>
                  </div>
                </div>
                {% if property.lot_size %}
                <div class="prop-stat">
                  <div class="prop-stat-icon"><i class="bi bi-tree"></i></div>
                  <div>
                    <span class="prop-stat-value">{{ property.lot_size|intcomma }}</span>
                    <span class="prop-stat-label">Lot Sq Ft</span>
                  </div>
                </div>
                {% endif %}
                {% if property.year_built %}
                <div class="prop-stat">
                  <div class="prop-stat-icon"><i class="bi bi-calendar3"></i></div>
                  <div>
                    <span class="prop-stat-value">{{ property.year_built }}</span>
                    <span class="prop-stat-label">Year Built</span>
                  </div>
                </div>
                {% endif %}
                <div class="prop-stat">
                  <div class="prop-stat-icon"><i class="bi bi-car-front"></i></div>
                  <div>
                    <span class="prop-stat-value">{{ property.parking_spaces }}</span>
                    <span class="prop-stat-label">Parking</span>
                  </div>
                </div>
              </div>

              <!-- Save messages -->
              <div class="action-msg success" id="property-messagge-success"></div>
              <div class="action-msg error" id="property-messagge-error"></div>

              <!-- Save / login button -->
              {% if user.is_authenticated %}
                {% if saved_property %}
                  <button class="btn-save btn-save-saved" disabled>
                    <i class="bi bi-bookmark-check-fill"></i> Property Saved
                  </button>
                {% else %}
                  <form id="property-id" method="post" action="{% url 'property_detail' property.slug %}">
                    {% csrf_token %}
                    <button id="save-btn" type="submit" class="btn-save btn-save-primary">
                      <i class="bi bi-bookmark-plus"></i> Save Property
                    </button>
                  </form>
                {% endif %}
              {% else %}
                <a class="btn-save btn-save-login" href="{% url 'users:login' %}?next={{ request.path }}">
                  <i class="bi bi-person-lock"></i> Login to Save Property
                </a>
              {% endif %}
            </div>

            <!-- Agent Card -->
            <div class="agent-card">
              <div class="agent-card-header"><i class="bi bi-person-badge me-2"></i>Listed By</div>

              <div class="agent-profile-row">
                <div class="agent-avatar">
                  {% if property.agent %}
                    <a href="{% url 'agents:agent_profile' property.agent.slug %}">
                      <img src="{% if property.agent.user.profile_image %}{{ property.agent.user.profile_image.url }}{% else %}{% static 'assets/img/real-estate/agent-3.webp' %}{% endif %}" alt="{{ property.agent.user.get_full_name }}">
                    </a>
                  {% else %}
                    <img src="{% static 'assets/img/real-estate/agent-3.webp' %}" alt="{{ property.listed_by.get_full_name }}">
                  {% endif %}
                </div>
                <div>
                  {% if property.agent %}
                    <a class="agent-name" href="{% url 'agents:agent_profile' property.agent.slug %}">
                      {{ property.agent.user.get_full_name|default:property.agent.user.username }}
                    </a>
                    <span class="agent-role">Listing Agent</span>
                    {% if property.agent.verification_status == 'verified' %}
                    <div class="badge-verified"><i class="bi bi-patch-check-fill"></i> Verified</div>
                    {% endif %}
                  {% else %}
                    <span class="agent-name" style="cursor:default;">{{ property.listed_by.get_full_name|default:property.listed_by.username }}</span>
                    <span class="agent-role">Listing Agent</span>
                  {% endif %}
                </div>
              </div>

              {% if property.agent %}
              <a href="{% url 'agents:agent_properties' property.agent.slug %}" class="btn-agent-props">
                <i class="bi bi-house-door"></i> View All Agent Properties
              </a>
              {% endif %}
            </div>

            <!-- Referral Card -->
            {% if referral_link %}
            <div class="referral-card">
              <h5><i class="bi bi-cash-coin"></i> Earn Commission</h5>
              <p>Share this property and earn a commission on sale!</p>
              <div class="referral-input-wrap">
                <input type="text" value="{{ referral_link }}" id="referralLink" readonly>
                <button class="btn-copy-ref" type="button" onclick="copyReferralLink()">
                  <i class="bi bi-clipboard"></i> Copy
                </button>
              </div>
            </div>
            {% endif %}

            <!-- Share -->
            <div class="share-card">
              <div class="share-label">Share This Property</div>
              <div class="share-buttons">
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}" target="_blank" rel="noopener" class="share-btn facebook" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
                <a href="https://twitter.com/intent/tweet?text={{ property.title|urlencode }}&url={{ request.build_absolute_uri|urlencode }}" target="_blank" rel="noopener" class="share-btn twitter" aria-label="Twitter"><i class="bi bi-twitter-x"></i></a>
                <a href="https://wa.me/?text={{ property.title|urlencode }}%20{{ request.build_absolute_uri|urlencode }}" target="_blank" rel="noopener" class="share-btn whatsapp" aria-label="WhatsApp"><i class="bi bi-whatsapp"></i></a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}" target="_blank" rel="noopener" class="share-btn linkedin" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a>
                <a href="mailto:?subject={{ property.title|urlencode }}&body={{ request.build_absolute_uri }}" class="share-btn email" aria-label="Email"><i class="bi bi-envelope"></i></a>
                <button type="button" class="share-btn copy-link" onclick="copyPropertyLink()" aria-label="Copy link"><i class="bi bi-link-45deg"></i></button>
              </div>

              {% if not referral_link and user.is_authenticated and not user.agent_profile %}
              <a href="{% url 'agents:agents_signup' %}" class="become-agent-link">
                <i class="bi bi-person-plus"></i> Become an agent to earn commission
              </a>
              {% endif %}
            </div>

          </div>
        </div>

      </div>
    </div>
  </section>

</main>
{% endblock content %}

{% block extra_scripts %}
<script>
// ---- Gallery navigation
(function () {
  const thumbnails = Array.from(document.querySelectorAll('.thumbnail-item'));
  const mainImg = document.getElementById('main-product-image');
  const counter = document.getElementById('imgCounter');
  let currentIdx = 0;

  function goTo(idx) {
    if (!thumbnails.length) return;
    currentIdx = (idx + thumbnails.length) % thumbnails.length;
    const item = thumbnails[currentIdx];
    const src = item.dataset.image;
    mainImg.style.opacity = '0';
    mainImg.style.transform = 'scale(0.97)';
    setTimeout(() => {
      mainImg.src = src;
      mainImg.style.opacity = '1';
      mainImg.style.transform = '';
      if (counter) counter.textContent = `${currentIdx + 1} / ${thumbnails.length}`;
    }, 220);
    thumbnails.forEach(t => t.classList.remove('active'));
    item.classList.add('active');
  }

  mainImg.style.transition = 'opacity 0.22s ease, transform 0.22s ease';

  thumbnails.forEach((t, i) => {
    t.addEventListener('click', () => goTo(i));
  });

  document.querySelector('.prev-image')?.addEventListener('click', () => goTo(currentIdx - 1));
  document.querySelector('.next-image')?.addEventListener('click', () => goTo(currentIdx + 1));

  // Keyboard navigation
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowLeft') goTo(currentIdx - 1);
    if (e.key === 'ArrowRight') goTo(currentIdx + 1);
  });
})();

// ---- Save property AJAX
document.addEventListener('DOMContentLoaded', () => {
  const saveForm = document.getElementById('property-id');
  const saveSuccessMsg = document.getElementById('property-messagge-success');
  const saveErrorMsg = document.getElementById('property-messagge-error');
  const submitBtn = document.getElementById('save-btn');

  function getCsrfToken() {
    const match = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
    return match ? match.trim().split('=')[1] : null;
  }

  saveForm?.addEventListener('submit', e => {
    e.preventDefault();
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving…';
    submitBtn.disabled = true;

    fetch(saveForm.action, {
      method: 'POST',
      body: new FormData(saveForm),
      headers: { 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        saveSuccessMsg.textContent = data.message;
        saveSuccessMsg.style.display = 'block';
        setTimeout(() => {
          saveSuccessMsg.style.display = 'none';
          submitBtn.innerHTML = '<i class="bi bi-bookmark-check-fill"></i> Property Saved';
          submitBtn.disabled = false;
        }, 3000);
      } else {
        saveErrorMsg.textContent = data.message;
        saveErrorMsg.style.display = 'block';
        setTimeout(() => {
          saveErrorMsg.style.display = 'none';
          submitBtn.innerHTML = '<i class="bi bi-bookmark-plus"></i> Save Property';
          submitBtn.disabled = false;
        }, 3000);
      }
      saveForm.reset();
    });
  });
});

// ---- Share helpers
function copyReferralLink() {
  const input = document.getElementById('referralLink');
  navigator.clipboard.writeText(input.value).then(() => {
    const btn = document.querySelector('.btn-copy-ref');
    btn.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
    setTimeout(() => { btn.innerHTML = '<i class="bi bi-clipboard"></i> Copy'; }, 2000);
  });
}

function copyPropertyLink() {
  const btn = event.target.closest('button');
  navigator.clipboard.writeText(window.location.href).then(() => {
    const orig = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check-lg"></i>';
    btn.classList.add('copied');
    setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('copied'); }, 2000);
  });
}
</script>
{% endblock %}