{% extends 'base.html' %}

{% load static %}
{% load humanize %}
{% load property_extras %}

{% load embed_video_tags %}

{% block seo_meta %}
{% include 'includes/seo_meta.html' %}
{% endblock seo_meta %}

{% block title %}{{ property.title }} - {{ property.status.get_name_display }} in {{ property.city.name }} | Nestova{% endblock %}

{% block extra_head %}
{# Structured Data for Property Listing #}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "RealEstateListing",
  "name": "{{ property.title|escapejs }}",
  "description": "{{ property.description|striptags|truncatewords:50|escapejs }}",
  "url": "{{ request.build_absolute_uri }}",
  "image": "{% if property.featured_image %}{{ request.scheme }}://{{ request.get_host }}{{ property.featured_image.url }}{% endif %}",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "{{ property.address|escapejs }}",
    "addressLocality": "{{ property.city.name|escapejs }}",
    "addressRegion": "{{ property.state.name|escapejs }}",
    "addressCountry": "NG"
  },
  "geo": {
    "@type": "GeoCoordinates"
    {% if property.latitude and property.longitude %}
    ,"latitude": "{{ property.latitude }}",
    "longitude": "{{ property.longitude }}"
    {% endif %}
  },
  "offers": {
    "@type": "Offer",
    "price": "{{ property.price }}",
    "priceCurrency": "NGN",
    "availability": "https://schema.org/InStock",
    "url": "{{ request.build_absolute_uri }}"
  },
  "numberOfRooms": "{{ property.bedrooms }}",
  "numberOfBathroomsTotal": "{{ property.bathrooms }}",
  "floorSize": {
    "@type": "QuantitativeValue",
    "value": "{{ property.square_feet }}",
    "unitCode": "FTK"
  }
  {% if property.year_built %}
  ,"yearBuilt": "{{ property.year_built }}"
  {% endif %}
}
</script>
{% endblock extra_head %}

{% block content %}



<main class="main">

  <!-- Page Title -->
  <div class="page-title">
    <div class="heading">
      <div class="container">
        <div class="row d-flex justify-content-center text-center">
          <div class="col-lg-8">
            <h1 class="heading-title">{{ property.title }}</h1>
          </div>
        </div>
      </div>
    </div>
    <nav class="breadcrumbs">
      <div class="container">
        <ol>
          <li><a href="{% url 'home' %}">Home</a></li>
          <li class="current">{{ property.title }}</li>
        </ol>
      </div>
    </nav>
  </div><!-- End Page Title -->

  <!-- Property Details Section -->
  <section id="property-details" class="property-details section">

    <div class="container" data-aos="fade-up" data-aos-delay="100">

      <div class="row gy-4">

        <div class="col-lg-8">

          <!-- Property Gallery -->
          <div class="property-gallery" data-aos="fade-up" data-aos-delay="200">
            <div class="main-image-container image-zoom-container">

              {% if property.featured_image %}
              <img id="main-product-image" src="{{ property.featured_image.url }}" alt="{{ property.title }}"
                class="img-fluid main-property-image" data-zoom="{{ property.featured_image.url }}">
              {% else %}
              <img id="main-product-image" src="{% static 'assets/img/real-estate/property-exterior-3.webp' %}"
                alt="Default Image" class="img-fluid main-property-image"
                data-zoom="{% static 'assets/img/real-estate/property-exterior-3.webp' %}">
              {% endif %}

              <div class="image-nav-buttons">
                <button class="image-nav-btn prev-image" type="button">
                  <i class="bi bi-chevron-left"></i>
                </button>
                <button class="image-nav-btn next-image" type="button">
                  <i class="bi bi-chevron-right"></i>
                </button>
              </div>
            </div>
            <div class="thumbnail-gallery thumbnail-list">
              {% if property.featured_image %}
              <div class="thumbnail-item active" data-image="{{ property.featured_image.url }}">
                <img src="{{ property.featured_image.url }}" alt="{{ property.title }}" class="img-fluid">
              </div>
              {% endif %}

              {% for image in property.images.all %}
              <div class="thumbnail-item" data-image="{{ image.image.url }}">
                <img src="{{ image.image.url }}" alt="{{ image.caption|default:property.title }}" class="img-fluid">
              </div>
              {% empty %}
              <!-- Fallback thumbnails if no extra images -->
              {% if not property.featured_image %}
              <div class="thumbnail-item active"
                data-image="{% static 'assets/img/real-estate/property-exterior-3.webp' %}">
                <img src="{% static 'assets/img/real-estate/property-exterior-3.webp' %}" alt="Property Exterior"
                  class="img-fluid">
              </div>
              {% endif %}
              {% endfor %}
            </div>
          </div><!-- End Property Gallery -->

          <!-- Property Description -->
          <div class="property-description" data-aos="fade-up" data-aos-delay="300">
            <h3>About This Property</h3>
            {{ property.description|safe }}
          </div><!-- End Property Description -->

          <!-- Amenities -->
          <div class="property-amenities" data-aos="fade-up" data-aos-delay="400">
            <h3>Amenities &amp; Features</h3>
            <div class="row">
              <div class="col-md-6">
                <h4>Features</h4>
                <ul class="features-list">
                  {% if property.has_garage %}<li><i class="bi bi-check-circle"></i>Garage</li>{% endif %}
                  {% if property.has_pool %}<li><i class="bi bi-check-circle"></i>Swimming Pool</li>{% endif %}
                  {% if property.has_garden %}<li><i class="bi bi-check-circle"></i>Garden</li>{% endif %}
                  {% if property.has_security %}<li><i class="bi bi-check-circle"></i>Security System</li>{% endif %}
                  {% if property.has_gym %}<li><i class="bi bi-check-circle"></i>Gym</li>{% endif %}
                  {% if property.has_balcony %}<li><i class="bi bi-check-circle"></i>Balcony / Patio</li>{% endif %}
                  {% if property.is_furnished %}<li><i class="bi bi-check-circle"></i>Furnished</li>{% endif %}
                  {% if property.has_ac %}<li><i class="bi bi-check-circle"></i>Air Conditioning</li>{% endif %}
                  {% if property.has_heating %}<li><i class="bi bi-check-circle"></i>Heating</li>{% endif %}
                </ul>
              </div>

              {% if property.additional_features %}
              <div class="col-md-6">
                <h4>Additional</h4>
                <ul class="features-list">
                  {% for key, value in property.additional_features.items %}
                  <li><i class="bi bi-check-circle"></i>{{ key }}: {{ value }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}

            </div>
          </div><!-- End Amenities -->

          <!-- Video Section -->
          {% if property.video_url %}
          <div class="property-video" data-aos="fade-up" data-aos-delay="500">
            <h3>Property Video Tour</h3>
            <div class="ratio ratio-16x9">
              <iframe
                src="https://www.youtube-nocookie.com/embed/{{ property.video_url|youtube_id }}?rel=0&modestbranding=1"
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
              </iframe>
            </div>
          </div>
          {% endif %}



        </div>

        <div class="col-lg-4">

          <!-- Property Overview -->
          <div class="property-overview sticky-top">
            <div class="price-tag">{{ property.formatted_price }}{% if property.status.name == 'for_rent' %}<span>/mo</span>{% endif %}</div>
            <div
              class="property-status{% if property.status.name == 'for_rent' %}for-rent{% else %}for-sale{% endif %}">
              {{ property.status.get_name_display }}
            </div>

            <div class="property-address">
              <h4>{{ property.address }}</h4>
              <p>{{ property.city.name }}, {{ property.state.name }}</p>
            </div>

            <div class="property-stats">
              <div class="stat-item">
                <i class="bi bi-house"></i>
                <div>
                  <span class="value">{{ property.bedrooms }}</span>
                  <span class="label">Bedrooms</span>
                </div>
              </div>
              <div class="stat-item">
                <i class="bi bi-droplet"></i>
                <div>
                  <span class="value">{{ property.bathrooms }}</span>
                  <span class="label">Bathrooms</span>
                </div>
              </div>
              <div class="stat-item">
                <i class="bi bi-rulers"></i>
                <div>
                  <span class="value">{{ property.square_feet|intcomma }}</span>
                  <span class="label">Sq Ft</span>
                </div>
              </div>
              {% if property.lot_size %}
              <div class="stat-item">
                <i class="bi bi-tree"></i>
                <div>
                  <span class="value">{{ property.lot_size|intcomma }}</span>
                  <span class="label">Lot Sq Ft</span>
                </div>
              </div>
              {% endif %}

              {% if property.year_built %}
              <div class="stat-item">
                <i class="bi bi-calendar"></i>
                <div>
                  <span class="value">{{ property.year_built }}</span>
                  <span class="label">Year Built</span>
                </div>
              </div>
              {% endif %}

              <div class="stat-item">
                <i class="bi bi-car-front"></i>
                <div>
                  <span class="value">{{ property.parking_spaces }}</span>
                  <span class="label">Parking</span>
                </div>
              </div>
            </div>
            <p id="property-messagge-success" class="text-white bg-success p-3 rounded-3 text-center mt-4"
              style="display: none;"></p>
            <p id="property-messagge-error" class="text-white bg-danger p-3 rounded-3 text-center mt-4"
              style="display: none;"></p>
            <div class="container">
              <div class="login-container">
                {% if user.is_authenticated %}
                {% if saved_property %}

                <div class="d-grid mb-3">
                  <button class="btn btn-success">Property Saved</button>
                </div>

                {% else %}
                <form id="property-id" method="post" action="{% url 'property_detail' property.slug %}">
                  {% csrf_token %}
                  <div class="d-grid mb-3">
                    <button id="save-btn" type="submit" class="btn btn-success">Save Property</button>
                  </div>
                </form>
                {% endif %}

                {% else %}
                <div class="d-grid mb-3">
                  <a class="btn btn-success p-2 rounded-3" href="{% url 'users:login' %}?next={{ request.path }}">Login
                    To Save Property</a>
                </div>
                {% endif %}

              </div>
            </div>
            <!-- Agent Info -->
            <div class="agent-info">
              <div class="agent-avatar">
                {% if property.agent %}
                <a href="{% url 'agents:agent_profile' property.agent.slug %}">
                  <img
                    src="{% if property.agent.user.profile_image %}{{ property.agent.user.profile_image.url }}{% else %}{% static 'assets/img/real-estate/agent-3.webp' %}{% endif %}"
                    alt="{{ property.agent.user.get_full_name }}" class="img-fluid">
                </a>
                {% else %}
                <img src="{% static 'assets/img/real-estate/agent-3.webp' %}"
                  alt="{{ property.listed_by.get_full_name }}" class="img-fluid">
                {% endif %}
              </div>
              <div class="agent-details">
                {% if property.agent %}
                <h4>
                  <a href="{% url 'agents:agent_profile' property.agent.slug %}" class="text-decoration-none">
                    {{ property.agent.user.get_full_name|default:property.agent.user.username }}
                  </a>
                </h4>
                <p class="agent-title">Listing Agent</p>
                {% if property.agent.verification_status == 'verified' %}
                <span class="badge bg-success mb-2"><i class="bi bi-patch-check-fill"></i> Verified</span>
                {% endif %}
                <div class="mt-2">
                  <a href="{% url 'agents:agent_properties' property.agent.slug %}"
                    class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-house-door"></i> View All Properties
                  </a>
                </div>
                {% else %}
                <h4>{{ property.listed_by.get_full_name|default:property.listed_by.username }}</h4>
                <p class="agent-title">Listing Agent</p>
                {% endif %}
              </div>
            </div><!-- End Agent Info -->

            <!-- Contact Form -->


            {# Referral & Social Share #}
            <div class="social-share">
              {% if referral_link %}
              <div class="agent-referral mb-4 p-3 bg-light rounded border">
                <h5 class="text-primary fw-bold mb-2"><i class="bi bi-cash-coin me-2"></i>Earn Commission</h5>
                <p class="small text-muted mb-2">Share this property and earn commission on sale!</p>
                <div class="input-group mb-3">
                  <input type="text" class="form-control form-control-sm" value="{{ referral_link }}" id="referralLink"
                    readonly>
                  <button class="btn btn-primary btn-sm" type="button" onclick="copyReferralLink()">
                    <i class="bi bi-clipboard"></i> Copy
                  </button>
                </div>
              </div>
              {% endif %}

              <h5>Share This Property</h5>
              <div class="share-buttons">
                <!-- Facebook -->
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}"
                  target="_blank" rel="noopener noreferrer" class="share-btn facebook" aria-label="Share on Facebook">
                  <i class="bi bi-facebook"></i>
                </a>

                <!-- Twitter/X -->
                <a href="https://twitter.com/intent/tweet?text={{ property.title|urlencode }}%20-%20{{ property.formatted_price|urlencode }}&url={{ request.build_absolute_uri|urlencode }}"
                  target="_blank" rel="noopener noreferrer" class="share-btn twitter" aria-label="Share on Twitter">
                  <i class="bi bi-twitter-x"></i>
                </a>

                <!-- WhatsApp -->
                <a href="https://wa.me/?text={{ property.title|urlencode }}%20-%20{{ property.formatted_price|urlencode }}%20{{ request.build_absolute_uri|urlencode }}"
                  target="_blank" rel="noopener noreferrer" class="share-btn whatsapp" aria-label="Share on WhatsApp">
                  <i class="bi bi-whatsapp"></i>
                </a>

                <!-- LinkedIn -->
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}"
                  target="_blank" rel="noopener noreferrer" class="share-btn linkedin" aria-label="Share on LinkedIn">
                  <i class="bi bi-linkedin"></i>
                </a>

                <!-- Email -->
                <a href="mailto:?subject={{ property.title|urlencode }}&body=Check%20out%20this%20property:%20{{ property.title|urlencode }}%20-%20{{ property.formatted_price|urlencode }}%0A%0A{{ request.build_absolute_uri }}"
                  class="share-btn email" aria-label="Share via Email">
                  <i class="bi bi-envelope"></i>
                </a>

                <!-- Copy Link -->
                <button type="button" class="share-btn copy-link" onclick="copyPropertyLink()" aria-label="Copy Link">
                  <i class="bi bi-link-45deg"></i>
                </button>
              </div>

              {% if not referral_link and user.is_authenticated and not user.agent_profile %}
              <div class="mt-3">
                <a href="{% url 'agents:agents_signup' %}" class="small text-primary fw-bold">
                  <i class="bi bi-person-plus me-1"></i>Become an agent to earn commission
                </a>
              </div>
              {% endif %}
            </div><!-- End Social Share -->

            <script>
              function copyReferralLink() {
                var copyText = document.getElementById("referralLink");
                copyText.select();
                copyText.setSelectionRange(0, 99999); /* For mobile devices */
                navigator.clipboard.writeText(copyText.value).then(function () {
                  alert("Referral link copied to clipboard!");
                }, function (err) {
                  console.error('Could not copy text: ', err);
                });
              }

              function copyPropertyLink() {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(function () {
                  // Show success feedback
                  const btn = event.target.closest('button');
                  const originalHTML = btn.innerHTML;
                  btn.innerHTML = '<i class="bi bi-check"></i>';
                  btn.classList.add('copied');
                  setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('copied');
                  }, 2000);
                }, function (err) {
                  console.error('Could not copy link: ', err);
                  alert('Failed to copy link');
                });
              }
            </script>

          </div><!-- End Property Overview -->

        </div>

      </div>

    </div>

  </section><!-- /Property Details Section -->

</main>


<script>

  document.addEventListener("DOMContentLoaded", () => {
    const saveForm = document.getElementById("property-id");
    const saveSuccessMessage = document.getElementById("property-messagge-success");
    const saveErrorMessage = document.getElementById("property-messagge-error");
    const submitBtn = document.getElementById("save-btn");
    const url = saveForm ? saveForm.action : '';
    const getCsrfToken = () => {
      const cookieName = 'csrftoken';
      const cookies = document.cookie.split(';').map(c => c.trim());

      for (const cookie of cookies) {
        if (cookie.startsWith(`${cookieName}=`)) {
          return cookie.substring(cookieName.length + 1);
        }
      }

      console.error(`CSRF token cookie "${cookieName}" not found.`);
      return null;
    };
    saveForm && saveForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const csrfToken = getCsrfToken();
      submitBtn.textContent = "Saving Property";
      submitBtn.disabled = true;
      const formData = new FormData(saveForm);
      fetch(url, {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest",
        }
      }).then((response) => {
        return response.json()
      }).then((data) => {
        if (data.status === "success") {
          saveSuccessMessage.style.display = "block",
            saveSuccessMessage.innerHTML = data.message;
          setTimeout(() => {
            saveSuccessMessage.style.display = "none";
            saveSuccessMessage.innerHTML = "";
            submitBtn.textContent = "Property Saved";
            submitBtn.disabled = false;
          }, 3000);
          saveForm.reset()
        } else {
          saveErrorMessage.style.display = "block";
          saveErrorMessage.innerHTML = data.message;
          setTimeout(() => {
            saveErrorMessage.style.display = "none";
            saveErrorMessage.innerHTML = "";
            submitBtn.textContent = "Save Property";
            submitBtn.disabled = false;
          }, 3000);
          saveForm.reset()
        }
      })
    })


  })


</script>
{% endblock content %}